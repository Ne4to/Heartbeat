@page "/instance-type-statistics"
@using Heartbeat.Domain
@using Heartbeat.Runtime
@using Heartbeat.Runtime.Analyzers
@inject RuntimeContext Context

<PageTitle>Instance type statistics</PageTitle>

@*<StackPanel Orientation="Horizontal">
    <hc:TraversingHeapModeComboBox Mode="{x:Bind ViewModel.HeapMode, Mode=TwoWay}" />
    <Button Content="Refresh" Command="{x:Bind ViewModel.RefreshCommand}" VerticalAlignment="Bottom" Margin="8,0,0,0" />
    <TextBox Header="Search term"  Text="{x:Bind ViewModel.SearchTerm, Mode=TwoWay}" Width="200" />
    <Button Content="Search" Command="{x:Bind ViewModel.SearchCommand}" VerticalAlignment="Bottom" />
</StackPanel>

<ProgressBar Grid.Row="1" IsIndeterminate="True" Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}" />*@

<RadzenDataGrid TItem="ObjectTypeStatistics" AllowFiltering="true" AllowColumnResize="true" AllowSorting="true"
                PageSize="12" AllowPaging="true"
                Data="@Statistics">
    <Columns>
        <RadzenDataGridColumn TItem="ObjectTypeStatistics" Property="InstanceCount" Title="Count" TextAlign="TextAlign.Right" Width="100px" />
        <RadzenDataGridColumn TItem="ObjectTypeStatistics" Property="TotalSize" Title="Total size" TextAlign="TextAlign.Right" Width="140px">
            <FooterTemplate>
                @Size.Sum(@Statistics.Select(s => s.TotalSize))
            </FooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ObjectTypeStatistics" Property="TypeName" Title="Type" />
    </Columns>
</RadzenDataGrid>

@code {
    public IReadOnlyCollection<ObjectTypeStatistics> Statistics { get; private set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        var analyzer = new ObjectTypeStatisticsAnalyzer(Context);
        analyzer.TraversingHeapMode = TraversingHeapModes.All; // TODO add UI combobox

        var res = analyzer.GetObjectTypeStatistics();
        //Statistics = res.OrderByDescending(r => r.TotalSize).Take(200).ToArray();
        Statistics = res;
    }
}