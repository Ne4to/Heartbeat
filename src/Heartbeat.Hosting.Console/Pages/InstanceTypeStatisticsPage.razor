@page "/instance-type-statistics"
@inject RuntimeContext Context

<PageTitle>Instance type statistics</PageTitle>

<h1>Instance type statistics</h1>

@if (statsRaw == null)
{
    <FluentProgressRing />
}
else
{
    <FluentTextField @oninput="FilterChanged">Filter type</FluentTextField>
    <FluentDataGrid id="sortingGrid" GridTemplateColumns="4fr 1fr 1fr" RowsData=stats ColumnDefinitions=SortingColumnsGrid>
        <HeaderCellTemplate>
            <FluentButton @onclick=@(()=>SortColumn(context))>
                @context.Title
                @if (context.Title == lastSortColumn?.Title)
            {
                @(isAscending ? " ↑" : " ↓")
            }
        </FluentButton>
    </HeaderCellTemplate>
</FluentDataGrid>
}


@code {
    private List<Domain.ObjectTypeStatistics>? statsRaw;
    private List<Domain.ObjectTypeStatistics>? stats;

    public List<ColumnDefinition<Domain.ObjectTypeStatistics>> SortingColumnsGrid = new();
    private ColumnDefinition<Domain.ObjectTypeStatistics>? lastSortColumn = null;
    private bool isAscending = false;
    public string filterValue = "";

    protected override void OnInitialized()
    {
        base.OnInitialized();

        SortingColumnsGrid.Add(new ColumnDefinition<Domain.ObjectTypeStatistics>("Type", x => x.TypeName));
        SortingColumnsGrid.Add(new ColumnDefinition<Domain.ObjectTypeStatistics>("Count", x => x.InstanceCount));
        SortingColumnsGrid.Add(new ColumnDefinition<Domain.ObjectTypeStatistics>("Total size", x => x.TotalSize));

        var analyzer = new Heartbeat.Runtime.Analyzers.ObjectTypeStatisticsAnalyzer(Context);
        statsRaw = (analyzer.GetObjectTypeStatistics()).ToList();
        stats = statsRaw;
    }

    private void FilterChanged(ChangeEventArgs args)
    {
        var filter = args.Value as string;

        if (statsRaw == null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(filter))
        {
            stats = statsRaw;
        }
        else
        {
            stats = statsRaw.Where(s => s.TypeName.Contains(filter, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        if (lastSortColumn != null)
        {
            stats.Sort(new StatisticsComparer(lastSortColumn.FieldSelector!, isAscending));
        }
    }

    private void SortColumn(ColumnDefinition<Domain.ObjectTypeStatistics> columnDefinition)
    {
        if (stats == null)
        {
            return;
        }

        if (lastSortColumn?.Title == columnDefinition.Title)
        {
            isAscending = !isAscending;
        }
        else
        {
            lastSortColumn = columnDefinition;
        }

        stats.Sort(new StatisticsComparer(columnDefinition.FieldSelector!, isAscending));
    }

    class StatisticsComparer : IComparer<Domain.ObjectTypeStatistics>
    {
        Func<Domain.ObjectTypeStatistics, object> _selector;
        bool _isAscending;

        public StatisticsComparer(Func<Domain.ObjectTypeStatistics, object> selector, bool isAscending)
        {
            _selector = selector;
            _isAscending = isAscending;
        }

        int IComparer<Domain.ObjectTypeStatistics>.Compare(Domain.ObjectTypeStatistics? x, Domain.ObjectTypeStatistics? y)
        {
            var xval = _selector(x!);
            var yval = _selector(y!);

            if (xval == null || yval == null)
            {
                return 0;
            }

            if (xval is string xString && yval is string yString)
            {
                if (xString == null || yString == null)
                    return 0;

                return string.Compare(xString, yString) * (_isAscending ? 1 : -1);
            }

            if (xval is int xInt && yval is int yInt)
            {
                return xInt.CompareTo(yInt) * (_isAscending ? 1 : -1);
            }

            if (xval is Domain.Size xSize && yval is Domain.Size ySize)
            {
                return xSize.CompareTo(ySize) * (_isAscending ? 1 : -1);
            }

            return 0;
        }
    }
}
